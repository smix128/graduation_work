include:
  - local: '/ci-cd-files/.gitlab-ci-app.yml'

variables:
  YA_K8S_CLUSTER_NAME: "k8s-ya-cluster"
  YA_POSTGRESQL_CLUSTER_NAME: "postgresql-cluster"
  PSQL_DB: "yelbdatabase"
  PSQL_DBUSER: "yelbdbuser"
  PSQL_DBPASSWORD: "yelbdbpassword"

stages:
  - redis_deploy
  - redis_delete
  - db_init
  - build
  - deploy
  - delete

.yc_init:
  before_script:
    - set -x
    - yc config profile create profile1
    - yc config set cloud-id $YA_CLOUD_ID
    - yc config set folder-id $YA_FOLDER_ID
    - yc config set token $YA_TOKEN
    - yc managed-kubernetes cluster get-credentials $YA_K8S_CLUSTER_NAME --external
    - export YA_POSTGRESQL_CLUSTER_ID=$(yc managed-postgresql cluster get --name $YA_POSTGRESQL_CLUSTER_NAME | head -n1 | awk '{print $2}')
    - export YELB_DB_SERVER_ENDPOINT="c-${YA_POSTGRESQL_CLUSTER_ID}.rw.mdb.yandexcloud.net"
    - export YC_BALANCER_ID=$(yc load-balancer network-load-balancer list | grep EXTERNAL | awk '{print $2}')
    - export YC_BALANCER_IP=$(yc load-balancer network-load-balancer get --id $YC_BALANCER_ID | grep address | head -n1 | awk '{print $2}')

redis_deploy:
  stage: redis_deploy
  image: s045841.gitlab.yandexcloud.net:5050/smix128/graduation_work/centos-tools:4
  extends:
    - .yc_init
  script: 
    - helm repo add bitnami https://charts.bitnami.com/bitnami
    - helm upgrade --install redis bitnami/redis -f helm/redis-values.yml
  when: manual

redis_delete:
  stage: redis_delete
  image: s045841.gitlab.yandexcloud.net:5050/smix128/graduation_work/centos-tools:4
  extends:
    - .yc_init
  script: helm uninstall redis
  when: manual

db_init:
  stage: db_init
  image: s045841.gitlab.yandexcloud.net:5050/smix128/graduation_work/centos-tools:4
  extends:
    - .yc_init
  script:
    - export YA_POSTGRESQL_CLUSTER_ID=$(yc managed-postgresql cluster get --name $YA_POSTGRESQL_CLUSTER_NAME | head -n1 | awk '{print $2}')
    - psql -a postgresql://${PSQL_DBUSER}:${PSQL_DBPASSWORD}@c-${YA_POSTGRESQL_CLUSTER_ID}.rw.mdb.yandexcloud.net:6432/${PSQL_DB}?sslmode=require -c "CREATE TABLE restaurants (name char(30), count integer, PRIMARY KEY (name));"
    - psql -a postgresql://${PSQL_DBUSER}:${PSQL_DBPASSWORD}@c-${YA_POSTGRESQL_CLUSTER_ID}.rw.mdb.yandexcloud.net:6432/${PSQL_DB}?sslmode=require -c "INSERT INTO restaurants (name, count) VALUES ('outback', 0);"
    - psql -a postgresql://${PSQL_DBUSER}:${PSQL_DBPASSWORD}@c-${YA_POSTGRESQL_CLUSTER_ID}.rw.mdb.yandexcloud.net:6432/${PSQL_DB}?sslmode=require -c "INSERT INTO restaurants (name, count) VALUES ('bucadibeppo', 0);"
    - psql -a postgresql://${PSQL_DBUSER}:${PSQL_DBPASSWORD}@c-${YA_POSTGRESQL_CLUSTER_ID}.rw.mdb.yandexcloud.net:6432/${PSQL_DB}?sslmode=require -c "INSERT INTO restaurants (name, count) VALUES ('chipotle', 0);"
    - psql -a postgresql://${PSQL_DBUSER}:${PSQL_DBPASSWORD}@c-${YA_POSTGRESQL_CLUSTER_ID}.rw.mdb.yandexcloud.net:6432/${PSQL_DB}?sslmode=require -c "INSERT INTO restaurants (name, count) VALUES ('ihop', 0);"
  allow_failure: true
  when: manual

.var_appserver:
  variables:
    APP_NAME: "yelb-appserver"
    REPLICAS: "2"
    RACK_ENV: "custom"
    REDIS_SERVER_ENDPOINT: "redis-master.default.svc.cluster.local"
    YELB_DB_SERVER_ENDPOINT: $YELB_DB_SERVER_ENDPOINT
    HELM_ADDITIONAL_ARGS: "
      --set replicaCount=${REPLICAS}
      --set RACK_ENV=${RACK_ENV} \
      --set REDIS_SERVER_ENDPOINT=${REDIS_SERVER_ENDPOINT} \
      --set YELB_DB_SERVER_ENDPOINT=${YELB_DB_SERVER_ENDPOINT}
      "

.var_ui:
  variables:
    APP_NAME: "yelb-ui"
    REPLICAS: "2"
    HELM_ADDITIONAL_ARGS: "
      --set replicaCount=${REPLICAS}
      --set ingress.hosts[0].host=$YC_BALANCER_IP.nip.io
      "

.build_command:
  image: s045841.gitlab.yandexcloud.net:5050/smix128/graduation_work/centos-tools:4
  before_script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$APP_NAME:$CI_PIPELINE_ID -f $APP_NAME/Dockerfile $APP_NAME/
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$APP_NAME:$CI_PIPELINE_ID
  tags: 
    - shell
  when: manual

.helm_deploy: 
  image: s045841.gitlab.yandexcloud.net:5050/smix128/graduation_work/centos-tools:4
  script: |
    kubectl create secret docker-registry temp-secret-$APP_NAME \
      --docker-server=$CI_REGISTRY \
      --docker-username=gitlab-ci-token \
      --docker-password=$CI_BUILD_TOKEN
    export PULL_SECRET=$(kubectl get secrets temp-secret-$APP_NAME -o jsonpath="{.data['\.dockerconfigjson']}")
    kubectl delete secrets temp-secret-$APP_NAME
    set -x
    export YA_POSTGRESQL_CLUSTER_ID=$(yc managed-postgresql cluster get --name $YA_POSTGRESQL_CLUSTER_NAME | head -n1 | awk '{print $2}')
    export YELB_DB_SERVER_ENDPOINT="c-${YA_POSTGRESQL_CLUSTER_ID}.rw.mdb.yandexcloud.net"
    export YC_BALANCER_ID=$(yc load-balancer network-load-balancer list | grep EXTERNAL | awk '{print $2}')
    export YC_BALANCER_IP=$(yc load-balancer network-load-balancer get --id $YC_BALANCER_ID | grep address | head -n1 | awk '{print $2}')
    helm upgrade --install $APP_NAME helm/$APP_NAME/ --values helm/$APP_NAME/values.yaml \
      --set imagePullSecrets=$PULL_SECRET \
      --set image.repository=$CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$APP_NAME:$CI_PIPELINE_ID \
      $HELM_ADDITIONAL_ARGS 
  dependencies: []

.helm_delete:
  script:
    - helm uninstall $APP_NAME
  dependencies: []